'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _asobj = require("asobj");

var _classnames = _interopRequireDefault(require("classnames"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireDefault(require("react"));

var _theButton = require("the-button");

var _theCheck = require("the-check");

var _theComponentUtil = require("the-component-util");

var _theIcon = require("the-icon");

var _theSpin = require("the-spin");

var _theWindow = require("the-window");

var _setupVideoElm = _interopRequireDefault(require("./helpers/setupVideoElm"));

var _TheTalkStyle = _interopRequireDefault(require("./TheTalkStyle"));

var cssAmount = function cssAmount(v) {
  return typeof v === 'number' ? v + 'px' : v;
};
/**
 * Talking via webrtc
 */


var TheTalk =
/*#__PURE__*/
function (_React$Component) {
  (0, _inherits2.default)(TheTalk, _React$Component);
  (0, _createClass2.default)(TheTalk, null, [{
    key: "DisabledIcon",
    value: function DisabledIcon(_ref) {
      var present = _ref.present;

      if (!present) {
        return null;
      }

      return _react.default.createElement(_theIcon.TheIcon, {
        className: (0, _classnames.default)('the-talk-disabled-icon', TheTalk.DISABLED_ICON)
      });
    }
  }, {
    key: "LocalClient",
    value: function LocalClient(_ref2) {
      var client = _ref2.client,
          id = _ref2.id,
          onAudioToggle = _ref2.onAudioToggle,
          onVideoToggle = _ref2.onVideoToggle,
          renderClient = _ref2.renderClient,
          videoHeight = _ref2.videoHeight;

      if (!client) {
        return null;
      }

      var audioEnabled = client.audioEnabled,
          videoEnabled = client.videoEnabled;
      var content = renderClient(client);
      return _react.default.createElement("div", {
        className: "the-talk-local",
        id: id
      }, _react.default.createElement("video", {
        autoPlay: true,
        className: "the-talk-video",
        muted: true,
        playsInline: true,
        style: {
          height: videoHeight
        }
      }), content && _react.default.createElement("div", {
        className: "the-talk-content"
      }, content), _react.default.createElement("div", {
        className: (0, _classnames.default)('the-talk-actions', {})
      }, _react.default.createElement(_theButton.TheButton, {
        className: (0, _classnames.default)('the-talk-toggle', {
          'the-talk-toggle-disabled': !audioEnabled
        }),
        icon: TheTalk.AUDIO_ICON,
        onClick: onAudioToggle
      }, _react.default.createElement(TheTalk.DisabledIcon, {
        present: !audioEnabled
      })), _react.default.createElement(_theButton.TheButton, {
        className: (0, _classnames.default)('the-talk-toggle', {
          'the-talk-toggle-disabled': !videoEnabled
        }),
        icon: TheTalk.VIDEO_ICON,
        onClick: onVideoToggle
      }, _react.default.createElement(TheTalk.DisabledIcon, {
        present: !videoEnabled
      }))));
    }
  }, {
    key: "RemoteClient",
    value: function RemoteClient(_ref3) {
      var client = _ref3.client,
          id = _ref3.id,
          renderClient = _ref3.renderClient,
          videoHeight = _ref3.videoHeight;

      if (!client) {
        return null;
      }

      var content = renderClient(client);
      return _react.default.createElement("div", {
        className: "the-talk-remote",
        id: id
      }, _react.default.createElement("video", {
        autoPlay: true,
        className: "the-talk-video",
        playsInline: true,
        style: {
          height: videoHeight
        }
      }), content && _react.default.createElement("div", {
        className: "the-talk-content"
      }, content));
    }
  }]);

  function TheTalk(props) {
    var _this;

    (0, _classCallCheck2.default)(this, TheTalk);
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(TheTalk).call(this, props));
    _this.handleAudioToggle = _this.handleAudioToggle.bind((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)));
    _this.handleVideoToggle = _this.handleVideoToggle.bind((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)));
    _this.elmRef = _react.default.createRef();
    _this._id = (0, _theComponentUtil.newId)();
    return _this;
  }

  (0, _createClass2.default)(TheTalk, [{
    key: "componentDidMount",
    value: function componentDidMount() {}
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate(prevProps) {
      var diff = (0, _theComponentUtil.changedProps)(prevProps, this.props);

      if ('localClient' in diff) {
        void this.receiveLocalClient(diff.localClient);
      }

      if ('remoteClients' in diff) {
        void this.receiveRemoteClients(diff.remoteClients);
      }
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {}
  }, {
    key: "handleAudioToggle",
    value: function handleAudioToggle() {
      var _this$props = this.props,
          localClient = _this$props.localClient,
          onToggleAudio = _this$props.onToggleAudio;

      var _ref4 = localClient || {},
          audioEnabled = _ref4.audioEnabled;

      onToggleAudio && onToggleAudio(!audioEnabled);
    }
  }, {
    key: "handleVideoToggle",
    value: function handleVideoToggle() {
      var _this$props2 = this.props,
          localClient = _this$props2.localClient,
          onToggleVideo = _this$props2.onToggleVideo;

      var _ref5 = localClient || {},
          videoEnabled = _ref5.videoEnabled;

      onToggleVideo && onToggleVideo(!videoEnabled);
    }
  }, {
    key: "remoteClientElmIdFor",
    value: function remoteClientElmIdFor(rid) {
      return "".concat(this.id, "-remote-").concat(rid);
    }
  }, {
    key: "render",
    value: function render() {
      var _this2 = this;

      var props = this.props;
      var children = props.children,
          className = props.className,
          localClient = props.localClient,
          localVideoHeight = props.localVideoHeight,
          remoteClients = props.remoteClients,
          remoteVideoHeight = props.remoteVideoHeight,
          renderLocalClient = props.renderLocalClient,
          renderRemoteClient = props.renderRemoteClient,
          spinning = props.spinning;
      return _react.default.createElement("div", (0, _extends2.default)({}, (0, _theComponentUtil.htmlAttributesFor)(props, {
        except: ['className']
      }), (0, _theComponentUtil.eventHandlersFor)(props, {
        except: []
      }), {
        className: (0, _classnames.default)('the-talk', className, {
          'the-talk-ready': !!localClient
        }),
        id: this.id,
        ref: this.elmRef
      }), spinning && _react.default.createElement(_theSpin.TheSpin, {
        cover: true,
        enabled: true
      }), _react.default.createElement("div", {
        className: "the-talk-video-remote-container"
      }, Object.entries(remoteClients).map(function (_ref6) {
        var _ref7 = (0, _slicedToArray2.default)(_ref6, 2),
            rid = _ref7[0],
            client = _ref7[1];

        return _react.default.createElement(TheTalk.RemoteClient, {
          client: client,
          id: _this2.remoteClientElmIdFor(rid),
          key: rid,
          renderClient: renderRemoteClient,
          videoHeight: cssAmount(remoteVideoHeight)
        });
      })), _react.default.createElement("div", {
        className: "the-talk-video-local-container"
      }, _react.default.createElement(TheTalk.LocalClient, {
        client: localClient,
        id: this.localClientElmId,
        onAudioToggle: this.handleAudioToggle,
        onVideoToggle: this.handleVideoToggle,
        renderClient: renderLocalClient,
        videoHeight: cssAmount(localVideoHeight)
      })), children);
    }
  }, {
    key: "receiveLocalClient",
    value: function () {
      var _receiveLocalClient = (0, _asyncToGenerator2.default)(
      /*#__PURE__*/
      _regenerator.default.mark(function _callee(localClient) {
        var document, clientElm, videoElm;
        return _regenerator.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                document = (0, _theWindow.get)('document');
                clientElm = document.getElementById(this.localClientElmId);

                if (clientElm) {
                  _context.next = 5;
                  break;
                }

                console.warn('[TheTalk] local clientElm not ready');
                return _context.abrupt("return");

              case 5:
                videoElm = clientElm.querySelector('video');
                _context.next = 8;
                return (0, _setupVideoElm.default)(videoElm, {
                  local: true,
                  stream: localClient.stream
                });

              case 8:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function receiveLocalClient(_x) {
        return _receiveLocalClient.apply(this, arguments);
      }

      return receiveLocalClient;
    }()
  }, {
    key: "receiveRemoteClients",
    value: function () {
      var _receiveRemoteClients = (0, _asyncToGenerator2.default)(
      /*#__PURE__*/
      _regenerator.default.mark(function _callee2(remoteClients) {
        var document, _arr, _i, _arr$_i, rid, client, clientElm, videoElm;

        return _regenerator.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                document = (0, _theWindow.get)('document');
                _arr = Object.entries(remoteClients);
                _i = 0;

              case 3:
                if (!(_i < _arr.length)) {
                  _context2.next = 15;
                  break;
                }

                _arr$_i = (0, _slicedToArray2.default)(_arr[_i], 2), rid = _arr$_i[0], client = _arr$_i[1];
                clientElm = document.getElementById(this.remoteClientElmIdFor(rid));

                if (clientElm) {
                  _context2.next = 9;
                  break;
                }

                console.warn('[TheTalk] remote clientElm not ready');
                return _context2.abrupt("return");

              case 9:
                videoElm = clientElm.querySelector('video');
                _context2.next = 12;
                return (0, _setupVideoElm.default)(videoElm, {
                  local: false,
                  stream: client.stream
                });

              case 12:
                _i++;
                _context2.next = 3;
                break;

              case 15:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function receiveRemoteClients(_x2) {
        return _receiveRemoteClients.apply(this, arguments);
      }

      return receiveRemoteClients;
    }()
  }, {
    key: "id",
    get: function get() {
      return this.props.id || this._id;
    }
  }, {
    key: "localClientElmId",
    get: function get() {
      return "".concat(this.id, "-local");
    }
  }]);
  return TheTalk;
}(_react.default.Component);

TheTalk.AUDIO_ICON = 'fas fa-microphone';
TheTalk.VIDEO_ICON = 'fas fa-video';
TheTalk.DISABLED_ICON = 'fas fa-ban';
TheTalk.Style = _TheTalkStyle.default;
TheTalk.propTypes = {
  /** Handle video */
  localClient: _propTypes.default.object,
  onVideo: _propTypes.default.func,
  remoteClients: _propTypes.default.objectOf(_propTypes.default.object),
  renderLocalClient: _propTypes.default.func,
  renderRemoteClient: _propTypes.default.func,

  /** Height of video */
  videoHeight: _propTypes.default.oneOfType([_propTypes.default.string, _propTypes.default.number])
};
TheTalk.defaultProps = {
  localClient: null,
  localVideoHeight: 100,
  remoteClients: {},
  remoteVideoHeight: 200,
  renderLocalClient: function renderLocalClient() {
    return null;
  },
  renderRemoteClient: function renderRemoteClient() {
    return null;
  }
};
TheTalk.displayName = 'TheTalk';
var _default = TheTalk;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRoZVRhbGsuanN4Il0sIm5hbWVzIjpbImNzc0Ftb3VudCIsInYiLCJUaGVUYWxrIiwicHJlc2VudCIsIkRJU0FCTEVEX0lDT04iLCJjbGllbnQiLCJpZCIsIm9uQXVkaW9Ub2dnbGUiLCJvblZpZGVvVG9nZ2xlIiwicmVuZGVyQ2xpZW50IiwidmlkZW9IZWlnaHQiLCJhdWRpb0VuYWJsZWQiLCJ2aWRlb0VuYWJsZWQiLCJjb250ZW50IiwiaGVpZ2h0IiwiQVVESU9fSUNPTiIsIlZJREVPX0lDT04iLCJwcm9wcyIsImhhbmRsZUF1ZGlvVG9nZ2xlIiwiYmluZCIsImhhbmRsZVZpZGVvVG9nZ2xlIiwiZWxtUmVmIiwiUmVhY3QiLCJjcmVhdGVSZWYiLCJfaWQiLCJwcmV2UHJvcHMiLCJkaWZmIiwicmVjZWl2ZUxvY2FsQ2xpZW50IiwibG9jYWxDbGllbnQiLCJyZWNlaXZlUmVtb3RlQ2xpZW50cyIsInJlbW90ZUNsaWVudHMiLCJvblRvZ2dsZUF1ZGlvIiwib25Ub2dnbGVWaWRlbyIsInJpZCIsImNoaWxkcmVuIiwiY2xhc3NOYW1lIiwibG9jYWxWaWRlb0hlaWdodCIsInJlbW90ZVZpZGVvSGVpZ2h0IiwicmVuZGVyTG9jYWxDbGllbnQiLCJyZW5kZXJSZW1vdGVDbGllbnQiLCJzcGlubmluZyIsImV4Y2VwdCIsIk9iamVjdCIsImVudHJpZXMiLCJtYXAiLCJyZW1vdGVDbGllbnRFbG1JZEZvciIsImxvY2FsQ2xpZW50RWxtSWQiLCJkb2N1bWVudCIsImNsaWVudEVsbSIsImdldEVsZW1lbnRCeUlkIiwiY29uc29sZSIsIndhcm4iLCJ2aWRlb0VsbSIsInF1ZXJ5U2VsZWN0b3IiLCJsb2NhbCIsInN0cmVhbSIsIkNvbXBvbmVudCIsIlN0eWxlIiwiVGhlVGFsa1N0eWxlIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwib2JqZWN0Iiwib25WaWRlbyIsImZ1bmMiLCJvYmplY3RPZiIsIm9uZU9mVHlwZSIsInN0cmluZyIsIm51bWJlciIsImRlZmF1bHRQcm9w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WyIndXNlIHN0cmljdCdcblxuaW1wb3J0IHsgY2xlYW51cCB9IGZyb20gJ2Fzb2JqJ1xuaW1wb3J0IGMgZnJvbSAnY2xhc3NuYW1lcydcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCB7IFRoZUJ1dHRvbiB9IGZyb20gJ3RoZS1idXR0b24nXG5pbXBvcnQgeyBpc1Byb2R1Y3Rpb24gfSBmcm9tICd0aGUtY2hlY2snXG5pbXBvcnQgeyBjaGFuZ2VkUHJvcHMsIGV2ZW50SGFuZGxlcnNGb3IsIGh0bWxBdHRyaWJ1dGVzRm9yLCBuZXdJZCB9IGZyb20gJ3RoZS1jb21wb25lbnQtdXRpbCdcbmltcG9ydCB7IFRoZUljb24gfSBmcm9tICd0aGUtaWNvbidcbmltcG9ydCB7IFRoZVNwaW4gfSBmcm9tICd0aGUtc3BpbidcbmltcG9ydCB7IGdldCB9IGZyb20gJ3RoZS13aW5kb3cnXG5pbXBvcnQgc2V0dXBWaWRlb0VsbSBmcm9tICcuL2hlbHBlcnMvc2V0dXBWaWRlb0VsbSdcbmltcG9ydCBUaGVUYWxrU3R5bGUgZnJvbSAnLi9UaGVUYWxrU3R5bGUnXG5cbmNvbnN0IGNzc0Ftb3VudCA9ICh2KSA9PiB0eXBlb2YgdiA9PT0gJ251bWJlcicgPyB2ICsgJ3B4JyA6IHZcblxuLyoqXG4gKiBUYWxraW5nIHZpYSB3ZWJydGNcbiAqL1xuY2xhc3MgVGhlVGFsayBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIHN0YXRpYyBEaXNhYmxlZEljb24gKHsgcHJlc2VudCB9KSB7XG4gICAgaWYgKCFwcmVzZW50KSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPFRoZUljb24gY2xhc3NOYW1lPXtjKCd0aGUtdGFsay1kaXNhYmxlZC1pY29uJywgVGhlVGFsay5ESVNBQkxFRF9JQ09OKX0vPlxuICAgIClcbiAgfVxuXG4gIHN0YXRpYyBMb2NhbENsaWVudCAoe1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkF1ZGlvVG9nZ2xlLFxuICAgICAgICAgICAgICAgICAgICAgICAgb25WaWRlb1RvZ2dsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckNsaWVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpZGVvSGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAgIH0pIHtcbiAgICBpZiAoIWNsaWVudCkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gICAgY29uc3Qge1xuICAgICAgYXVkaW9FbmFibGVkLFxuICAgICAgdmlkZW9FbmFibGVkLFxuICAgIH0gPSBjbGllbnRcbiAgICBjb25zdCBjb250ZW50ID0gcmVuZGVyQ2xpZW50KGNsaWVudClcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9J3RoZS10YWxrLWxvY2FsJ1xuICAgICAgICAgICBpZD17aWR9XG4gICAgICA+XG4gICAgICAgIDx2aWRlbyBhdXRvUGxheVxuICAgICAgICAgICAgICAgY2xhc3NOYW1lPSd0aGUtdGFsay12aWRlbydcbiAgICAgICAgICAgICAgIG11dGVkXG4gICAgICAgICAgICAgICBwbGF5c0lubGluZVxuICAgICAgICAgICAgICAgc3R5bGU9e3sgaGVpZ2h0OiB2aWRlb0hlaWdodCB9fVxuICAgICAgICAvPlxuICAgICAgICB7Y29udGVudCAmJiA8ZGl2IGNsYXNzTmFtZT0ndGhlLXRhbGstY29udGVudCc+e2NvbnRlbnR9PC9kaXY+fVxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YygndGhlLXRhbGstYWN0aW9ucycsIHt9KX0+XG4gICAgICAgICAgPFRoZUJ1dHRvbiBjbGFzc05hbWU9e2MoJ3RoZS10YWxrLXRvZ2dsZScsIHtcbiAgICAgICAgICAgICd0aGUtdGFsay10b2dnbGUtZGlzYWJsZWQnOiAhYXVkaW9FbmFibGVkLFxuICAgICAgICAgIH0pfVxuICAgICAgICAgICAgICAgICAgICAgaWNvbj17VGhlVGFsay5BVURJT19JQ09OfVxuICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17b25BdWRpb1RvZ2dsZX1cbiAgICAgICAgICA+XG4gICAgICAgICAgICA8VGhlVGFsay5EaXNhYmxlZEljb24gcHJlc2VudD17IWF1ZGlvRW5hYmxlZH0vPlxuICAgICAgICAgIDwvVGhlQnV0dG9uPlxuICAgICAgICAgIDxUaGVCdXR0b24gY2xhc3NOYW1lPXtjKCd0aGUtdGFsay10b2dnbGUnLCB7XG4gICAgICAgICAgICAndGhlLXRhbGstdG9nZ2xlLWRpc2FibGVkJzogIXZpZGVvRW5hYmxlZCxcbiAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAgICAgICAgIGljb249e1RoZVRhbGsuVklERU9fSUNPTn1cbiAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e29uVmlkZW9Ub2dnbGV9XG4gICAgICAgICAgPlxuICAgICAgICAgICAgPFRoZVRhbGsuRGlzYWJsZWRJY29uIHByZXNlbnQ9eyF2aWRlb0VuYWJsZWR9Lz5cbiAgICAgICAgICA8L1RoZUJ1dHRvbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICApXG4gIH1cblxuICBzdGF0aWMgUmVtb3RlQ2xpZW50ICh7IGNsaWVudCwgaWQsIHJlbmRlckNsaWVudCwgdmlkZW9IZWlnaHQgfSkge1xuICAgIGlmICghY2xpZW50KSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICBjb25zdCBjb250ZW50ID0gcmVuZGVyQ2xpZW50KGNsaWVudClcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9J3RoZS10YWxrLXJlbW90ZSdcbiAgICAgICAgICAgaWQ9e2lkfVxuICAgICAgPlxuICAgICAgICA8dmlkZW8gYXV0b1BsYXlcbiAgICAgICAgICAgICAgIGNsYXNzTmFtZT0ndGhlLXRhbGstdmlkZW8nXG4gICAgICAgICAgICAgICBwbGF5c0lubGluZVxuICAgICAgICAgICAgICAgc3R5bGU9e3sgaGVpZ2h0OiB2aWRlb0hlaWdodCB9fVxuICAgICAgICAvPlxuICAgICAgICB7Y29udGVudCAmJiA8ZGl2IGNsYXNzTmFtZT0ndGhlLXRhbGstY29udGVudCc+e2NvbnRlbnR9PC9kaXY+fVxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgY29uc3RydWN0b3IgKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpXG4gICAgdGhpcy5oYW5kbGVBdWRpb1RvZ2dsZSA9IHRoaXMuaGFuZGxlQXVkaW9Ub2dnbGUuYmluZCh0aGlzKVxuICAgIHRoaXMuaGFuZGxlVmlkZW9Ub2dnbGUgPSB0aGlzLmhhbmRsZVZpZGVvVG9nZ2xlLmJpbmQodGhpcylcbiAgICB0aGlzLmVsbVJlZiA9IFJlYWN0LmNyZWF0ZVJlZigpXG4gICAgdGhpcy5faWQgPSBuZXdJZCgpXG4gIH1cblxuICBnZXQgaWQgKCkge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmlkIHx8IHRoaXMuX2lkXG4gIH1cblxuICBnZXQgbG9jYWxDbGllbnRFbG1JZCAoKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuaWR9LWxvY2FsYFxuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQgKCkge1xuICB9XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlIChwcmV2UHJvcHMpIHtcbiAgICBjb25zdCBkaWZmID0gY2hhbmdlZFByb3BzKHByZXZQcm9wcywgdGhpcy5wcm9wcylcbiAgICBpZiAoJ2xvY2FsQ2xpZW50JyBpbiBkaWZmKSB7XG4gICAgICB2b2lkIHRoaXMucmVjZWl2ZUxvY2FsQ2xpZW50KGRpZmYubG9jYWxDbGllbnQpXG4gICAgfVxuICAgIGlmICgncmVtb3RlQ2xpZW50cycgaW4gZGlmZikge1xuICAgICAgdm9pZCB0aGlzLnJlY2VpdmVSZW1vdGVDbGllbnRzKGRpZmYucmVtb3RlQ2xpZW50cylcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCAoKSB7XG4gIH1cblxuICBoYW5kbGVBdWRpb1RvZ2dsZSAoKSB7XG4gICAgY29uc3Qge1xuICAgICAgcHJvcHM6IHsgbG9jYWxDbGllbnQsIG9uVG9nZ2xlQXVkaW8gfSxcbiAgICB9ID0gdGhpc1xuICAgIGNvbnN0IHsgYXVkaW9FbmFibGVkIH0gPSBsb2NhbENsaWVudCB8fCB7fVxuICAgIG9uVG9nZ2xlQXVkaW8gJiYgb25Ub2dnbGVBdWRpbyghYXVkaW9FbmFibGVkKVxuICB9XG5cbiAgaGFuZGxlVmlkZW9Ub2dnbGUgKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHByb3BzOiB7IGxvY2FsQ2xpZW50LCBvblRvZ2dsZVZpZGVvIH0sXG4gICAgfSA9IHRoaXNcbiAgICBjb25zdCB7IHZpZGVvRW5hYmxlZCB9ID0gbG9jYWxDbGllbnQgfHwge31cbiAgICBvblRvZ2dsZVZpZGVvICYmIG9uVG9nZ2xlVmlkZW8oIXZpZGVvRW5hYmxlZClcbiAgfVxuXG4gIHJlbW90ZUNsaWVudEVsbUlkRm9yIChyaWQpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5pZH0tcmVtb3RlLSR7cmlkfWBcbiAgfVxuXG4gIHJlbmRlciAoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpc1xuICAgIGNvbnN0IHtcbiAgICAgIGNoaWxkcmVuLFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgbG9jYWxDbGllbnQsXG4gICAgICBsb2NhbFZpZGVvSGVpZ2h0LFxuICAgICAgcmVtb3RlQ2xpZW50cyxcbiAgICAgIHJlbW90ZVZpZGVvSGVpZ2h0LFxuICAgICAgcmVuZGVyTG9jYWxDbGllbnQsXG4gICAgICByZW5kZXJSZW1vdGVDbGllbnQsXG4gICAgICBzcGlubmluZyxcbiAgICB9ID0gcHJvcHNcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiB7Li4uaHRtbEF0dHJpYnV0ZXNGb3IocHJvcHMsIHsgZXhjZXB0OiBbJ2NsYXNzTmFtZSddIH0pfVxuICAgICAgICAgICB7Li4uZXZlbnRIYW5kbGVyc0Zvcihwcm9wcywgeyBleGNlcHQ6IFtdIH0pfVxuICAgICAgICAgICBjbGFzc05hbWU9e2MoJ3RoZS10YWxrJywgY2xhc3NOYW1lLCB7XG4gICAgICAgICAgICAgJ3RoZS10YWxrLXJlYWR5JzogISFsb2NhbENsaWVudCxcbiAgICAgICAgICAgfSl9XG4gICAgICAgICAgIGlkPXt0aGlzLmlkfVxuICAgICAgICAgICByZWY9e3RoaXMuZWxtUmVmfVxuICAgICAgPlxuXG4gICAgICAgIHtcbiAgICAgICAgICBzcGlubmluZyAmJiA8VGhlU3BpbiBjb3ZlciBlbmFibGVkLz5cbiAgICAgICAgfVxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ndGhlLXRhbGstdmlkZW8tcmVtb3RlLWNvbnRhaW5lcidcbiAgICAgICAgPlxuICAgICAgICAgIHtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlbW90ZUNsaWVudHMpLm1hcCgoW3JpZCwgY2xpZW50XSkgPT4gKFxuICAgICAgICAgICAgICA8VGhlVGFsay5SZW1vdGVDbGllbnQgY2xpZW50PXtjbGllbnR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD17dGhpcy5yZW1vdGVDbGllbnRFbG1JZEZvcihyaWQpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PXtyaWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJDbGllbnQ9e3JlbmRlclJlbW90ZUNsaWVudH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZGVvSGVpZ2h0PXtjc3NBbW91bnQocmVtb3RlVmlkZW9IZWlnaHQpfS8+XG4gICAgICAgICAgICApKVxuICAgICAgICAgIH1cbiAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J3RoZS10YWxrLXZpZGVvLWxvY2FsLWNvbnRhaW5lcidcbiAgICAgICAgPlxuICAgICAgICAgIDxUaGVUYWxrLkxvY2FsQ2xpZW50IGNsaWVudD17bG9jYWxDbGllbnR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ9e3RoaXMubG9jYWxDbGllbnRFbG1JZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkF1ZGlvVG9nZ2xlPXt0aGlzLmhhbmRsZUF1ZGlvVG9nZ2xlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uVmlkZW9Ub2dnbGU9e3RoaXMuaGFuZGxlVmlkZW9Ub2dnbGV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQ2xpZW50PXtyZW5kZXJMb2NhbENsaWVudH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWRlb0hlaWdodD17Y3NzQW1vdW50KGxvY2FsVmlkZW9IZWlnaHQpfVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvZGl2PlxuICAgIClcbiAgfVxuXG4gIGFzeW5jIHJlY2VpdmVMb2NhbENsaWVudCAobG9jYWxDbGllbnQpIHtcbiAgICBjb25zdCBkb2N1bWVudCA9IGdldCgnZG9jdW1lbnQnKVxuICAgIGNvbnN0IGNsaWVudEVsbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMubG9jYWxDbGllbnRFbG1JZClcbiAgICBpZiAoIWNsaWVudEVsbSkge1xuICAgICAgY29uc29sZS53YXJuKCdbVGhlVGFsa10gbG9jYWwgY2xpZW50RWxtIG5vdCByZWFkeScpXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgdmlkZW9FbG0gPSBjbGllbnRFbG0ucXVlcnlTZWxlY3RvcigndmlkZW8nKVxuICAgIGF3YWl0IHNldHVwVmlkZW9FbG0odmlkZW9FbG0sIHtcbiAgICAgIGxvY2FsOiB0cnVlLFxuICAgICAgc3RyZWFtOiBsb2NhbENsaWVudC5zdHJlYW0sXG4gICAgfSlcbiAgfVxuXG4gIGFzeW5jIHJlY2VpdmVSZW1vdGVDbGllbnRzIChyZW1vdGVDbGllbnRzKSB7XG4gICAgY29uc3QgZG9jdW1lbnQgPSBnZXQoJ2RvY3VtZW50JylcbiAgICBmb3IgKGNvbnN0IFtyaWQsIGNsaWVudF0gb2YgT2JqZWN0LmVudHJpZXMocmVtb3RlQ2xpZW50cykpIHtcbiAgICAgIGNvbnN0IGNsaWVudEVsbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMucmVtb3RlQ2xpZW50RWxtSWRGb3IocmlkKSlcbiAgICAgIGlmICghY2xpZW50RWxtKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignW1RoZVRhbGtdIHJlbW90ZSBjbGllbnRFbG0gbm90IHJlYWR5JylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBjb25zdCB2aWRlb0VsbSA9IGNsaWVudEVsbS5xdWVyeVNlbGVjdG9yKCd2aWRlbycpXG4gICAgICBhd2FpdCBzZXR1cFZpZGVvRWxtKHZpZGVvRWxtLCB7XG4gICAgICAgIGxvY2FsOiBmYWxzZSxcbiAgICAgICAgc3RyZWFtOiBjbGllbnQuc3RyZWFtLFxuICAgICAgfSlcbiAgICB9XG4gIH1cbn1cblxuVGhlVGFsay5BVURJT19JQ09OID0gJ2ZhcyBmYS1taWNyb3Bob25lJ1xuVGhlVGFsay5WSURFT19JQ09OID0gJ2ZhcyBmYS12aWRlbydcblRoZVRhbGsuRElTQUJMRURfSUNPTiA9ICdmYXMgZmEtYmFuJ1xuXG5UaGVUYWxrLlN0eWxlID0gVGhlVGFsa1N0eWxlXG5cblRoZVRhbGsucHJvcFR5cGVzID0ge1xuICAvKiogSGFuZGxlIHZpZGVvICovXG4gIGxvY2FsQ2xpZW50OiBQcm9wVHlwZXMub2JqZWN0LFxuICBvblZpZGVvOiBQcm9wVHlwZXMuZnVuYyxcbiAgcmVtb3RlQ2xpZW50czogUHJvcFR5cGVzLm9iamVjdE9mKFByb3BUeXBlcy5vYmplY3QpLFxuICByZW5kZXJMb2NhbENsaWVudDogUHJvcFR5cGVzLmZ1bmMsXG4gIHJlbmRlclJlbW90ZUNsaWVudDogUHJvcFR5cGVzLmZ1bmMsXG4gIC8qKiBIZWlnaHQgb2YgdmlkZW8gKi9cbiAgdmlkZW9IZWlnaHQ6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgIFByb3BUeXBlcy5zdHJpbmcsXG4gICAgUHJvcFR5cGVzLm51bWJlcixcbiAgXSksXG59XG5cblRoZVRhbGsuZGVmYXVsdFByb3BzID0ge1xuICBsb2NhbENsaWVudDogbnVsbCxcbiAgbG9jYWxWaWRlb0hlaWdodDogMTAwLFxuICByZW1vdGVDbGllbnRzOiB7fSxcbiAgcmVtb3RlVmlkZW9IZWlnaHQ6IDIwMCxcbiAgcmVuZGVyTG9jYWxDbGllbnQ6ICgpID0+IG51bGwsXG4gIHJlbmRlclJlbW90ZUNsaWVudDogKCkgPT4gbnVsbCxcbn1cblxuVGhlVGFsay5kaXNwbGF5TmFtZSA9ICdUaGVUYWxrJ1xuXG5leHBvcnQgZGVmYXVsdCBUaGVUYWxrXG4iXX0=