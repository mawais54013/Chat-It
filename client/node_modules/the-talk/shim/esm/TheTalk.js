'use strict';

import _regeneratorRuntime from "@babel/runtime/regenerator";
import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _extends from "@babel/runtime/helpers/extends";
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
import _classCallCheck from "@babel/runtime/helpers/classCallCheck";
import _possibleConstructorReturn from "@babel/runtime/helpers/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime/helpers/getPrototypeOf";
import _createClass from "@babel/runtime/helpers/createClass";
import _inherits from "@babel/runtime/helpers/inherits";
import _assertThisInitialized from "@babel/runtime/helpers/assertThisInitialized";
import { cleanup } from 'asobj';
import c from 'classnames';
import PropTypes from 'prop-types';
import React from 'react';
import { TheButton } from 'the-button';
import { isProduction } from 'the-check';
import { changedProps, eventHandlersFor, htmlAttributesFor, newId } from 'the-component-util';
import { TheIcon } from 'the-icon';
import { TheSpin } from 'the-spin';
import { get } from 'the-window';
import setupVideoElm from './helpers/setupVideoElm';
import TheTalkStyle from './TheTalkStyle';

var cssAmount = function cssAmount(v) {
  return typeof v === 'number' ? v + 'px' : v;
};
/**
 * Talking via webrtc
 */


var TheTalk =
/*#__PURE__*/
function (_React$Component) {
  _inherits(TheTalk, _React$Component);

  _createClass(TheTalk, null, [{
    key: "DisabledIcon",
    value: function DisabledIcon(_ref) {
      var present = _ref.present;

      if (!present) {
        return null;
      }

      return React.createElement(TheIcon, {
        className: c('the-talk-disabled-icon', TheTalk.DISABLED_ICON)
      });
    }
  }, {
    key: "LocalClient",
    value: function LocalClient(_ref2) {
      var client = _ref2.client,
          id = _ref2.id,
          onAudioToggle = _ref2.onAudioToggle,
          onVideoToggle = _ref2.onVideoToggle,
          renderClient = _ref2.renderClient,
          videoHeight = _ref2.videoHeight;

      if (!client) {
        return null;
      }

      var audioEnabled = client.audioEnabled,
          videoEnabled = client.videoEnabled;
      var content = renderClient(client);
      return React.createElement("div", {
        className: "the-talk-local",
        id: id
      }, React.createElement("video", {
        autoPlay: true,
        className: "the-talk-video",
        muted: true,
        playsInline: true,
        style: {
          height: videoHeight
        }
      }), content && React.createElement("div", {
        className: "the-talk-content"
      }, content), React.createElement("div", {
        className: c('the-talk-actions', {})
      }, React.createElement(TheButton, {
        className: c('the-talk-toggle', {
          'the-talk-toggle-disabled': !audioEnabled
        }),
        icon: TheTalk.AUDIO_ICON,
        onClick: onAudioToggle
      }, React.createElement(TheTalk.DisabledIcon, {
        present: !audioEnabled
      })), React.createElement(TheButton, {
        className: c('the-talk-toggle', {
          'the-talk-toggle-disabled': !videoEnabled
        }),
        icon: TheTalk.VIDEO_ICON,
        onClick: onVideoToggle
      }, React.createElement(TheTalk.DisabledIcon, {
        present: !videoEnabled
      }))));
    }
  }, {
    key: "RemoteClient",
    value: function RemoteClient(_ref3) {
      var client = _ref3.client,
          id = _ref3.id,
          renderClient = _ref3.renderClient,
          videoHeight = _ref3.videoHeight;

      if (!client) {
        return null;
      }

      var content = renderClient(client);
      return React.createElement("div", {
        className: "the-talk-remote",
        id: id
      }, React.createElement("video", {
        autoPlay: true,
        className: "the-talk-video",
        playsInline: true,
        style: {
          height: videoHeight
        }
      }), content && React.createElement("div", {
        className: "the-talk-content"
      }, content));
    }
  }]);

  function TheTalk(props) {
    var _this;

    _classCallCheck(this, TheTalk);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(TheTalk).call(this, props));
    _this.handleAudioToggle = _this.handleAudioToggle.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.handleVideoToggle = _this.handleVideoToggle.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.elmRef = React.createRef();
    _this._id = newId();
    return _this;
  }

  _createClass(TheTalk, [{
    key: "componentDidMount",
    value: function componentDidMount() {}
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate(prevProps) {
      var diff = changedProps(prevProps, this.props);

      if ('localClient' in diff) {
        void this.receiveLocalClient(diff.localClient);
      }

      if ('remoteClients' in diff) {
        void this.receiveRemoteClients(diff.remoteClients);
      }
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {}
  }, {
    key: "handleAudioToggle",
    value: function handleAudioToggle() {
      var _this$props = this.props,
          localClient = _this$props.localClient,
          onToggleAudio = _this$props.onToggleAudio;

      var _ref4 = localClient || {},
          audioEnabled = _ref4.audioEnabled;

      onToggleAudio && onToggleAudio(!audioEnabled);
    }
  }, {
    key: "handleVideoToggle",
    value: function handleVideoToggle() {
      var _this$props2 = this.props,
          localClient = _this$props2.localClient,
          onToggleVideo = _this$props2.onToggleVideo;

      var _ref5 = localClient || {},
          videoEnabled = _ref5.videoEnabled;

      onToggleVideo && onToggleVideo(!videoEnabled);
    }
  }, {
    key: "remoteClientElmIdFor",
    value: function remoteClientElmIdFor(rid) {
      return "".concat(this.id, "-remote-").concat(rid);
    }
  }, {
    key: "render",
    value: function render() {
      var _this2 = this;

      var props = this.props;
      var children = props.children,
          className = props.className,
          localClient = props.localClient,
          localVideoHeight = props.localVideoHeight,
          remoteClients = props.remoteClients,
          remoteVideoHeight = props.remoteVideoHeight,
          renderLocalClient = props.renderLocalClient,
          renderRemoteClient = props.renderRemoteClient,
          spinning = props.spinning;
      return React.createElement("div", _extends({}, htmlAttributesFor(props, {
        except: ['className']
      }), eventHandlersFor(props, {
        except: []
      }), {
        className: c('the-talk', className, {
          'the-talk-ready': !!localClient
        }),
        id: this.id,
        ref: this.elmRef
      }), spinning && React.createElement(TheSpin, {
        cover: true,
        enabled: true
      }), React.createElement("div", {
        className: "the-talk-video-remote-container"
      }, Object.entries(remoteClients).map(function (_ref6) {
        var _ref7 = _slicedToArray(_ref6, 2),
            rid = _ref7[0],
            client = _ref7[1];

        return React.createElement(TheTalk.RemoteClient, {
          client: client,
          id: _this2.remoteClientElmIdFor(rid),
          key: rid,
          renderClient: renderRemoteClient,
          videoHeight: cssAmount(remoteVideoHeight)
        });
      })), React.createElement("div", {
        className: "the-talk-video-local-container"
      }, React.createElement(TheTalk.LocalClient, {
        client: localClient,
        id: this.localClientElmId,
        onAudioToggle: this.handleAudioToggle,
        onVideoToggle: this.handleVideoToggle,
        renderClient: renderLocalClient,
        videoHeight: cssAmount(localVideoHeight)
      })), children);
    }
  }, {
    key: "receiveLocalClient",
    value: function () {
      var _receiveLocalClient = _asyncToGenerator(
      /*#__PURE__*/
      _regeneratorRuntime.mark(function _callee(localClient) {
        var document, clientElm, videoElm;
        return _regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                document = get('document');
                clientElm = document.getElementById(this.localClientElmId);

                if (clientElm) {
                  _context.next = 5;
                  break;
                }

                console.warn('[TheTalk] local clientElm not ready');
                return _context.abrupt("return");

              case 5:
                videoElm = clientElm.querySelector('video');
                _context.next = 8;
                return setupVideoElm(videoElm, {
                  local: true,
                  stream: localClient.stream
                });

              case 8:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function receiveLocalClient(_x) {
        return _receiveLocalClient.apply(this, arguments);
      }

      return receiveLocalClient;
    }()
  }, {
    key: "receiveRemoteClients",
    value: function () {
      var _receiveRemoteClients = _asyncToGenerator(
      /*#__PURE__*/
      _regeneratorRuntime.mark(function _callee2(remoteClients) {
        var document, _arr, _i, _arr$_i, rid, client, clientElm, videoElm;

        return _regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                document = get('document');
                _arr = Object.entries(remoteClients);
                _i = 0;

              case 3:
                if (!(_i < _arr.length)) {
                  _context2.next = 15;
                  break;
                }

                _arr$_i = _slicedToArray(_arr[_i], 2), rid = _arr$_i[0], client = _arr$_i[1];
                clientElm = document.getElementById(this.remoteClientElmIdFor(rid));

                if (clientElm) {
                  _context2.next = 9;
                  break;
                }

                console.warn('[TheTalk] remote clientElm not ready');
                return _context2.abrupt("return");

              case 9:
                videoElm = clientElm.querySelector('video');
                _context2.next = 12;
                return setupVideoElm(videoElm, {
                  local: false,
                  stream: client.stream
                });

              case 12:
                _i++;
                _context2.next = 3;
                break;

              case 15:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function receiveRemoteClients(_x2) {
        return _receiveRemoteClients.apply(this, arguments);
      }

      return receiveRemoteClients;
    }()
  }, {
    key: "id",
    get: function get() {
      return this.props.id || this._id;
    }
  }, {
    key: "localClientElmId",
    get: function get() {
      return "".concat(this.id, "-local");
    }
  }]);

  return TheTalk;
}(React.Component);

TheTalk.AUDIO_ICON = 'fas fa-microphone';
TheTalk.VIDEO_ICON = 'fas fa-video';
TheTalk.DISABLED_ICON = 'fas fa-ban';
TheTalk.Style = TheTalkStyle;
TheTalk.propTypes = {
  /** Handle video */
  localClient: PropTypes.object,
  onVideo: PropTypes.func,
  remoteClients: PropTypes.objectOf(PropTypes.object),
  renderLocalClient: PropTypes.func,
  renderRemoteClient: PropTypes.func,

  /** Height of video */
  videoHeight: PropTypes.oneOfType([PropTypes.string, PropTypes.number])
};
TheTalk.defaultProps = {
  localClient: null,
  localVideoHeight: 100,
  remoteClients: {},
  remoteVideoHeight: 200,
  renderLocalClient: function renderLocalClient() {
    return null;
  },
  renderRemoteClient: function renderRemoteClient() {
    return null;
  }
};
TheTalk.displayName = 'TheTalk';
export default TheTalk;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRoZVRhbGsuanMiXSwibmFtZXMiOlsiY2xlYW51cCIsImMiLCJQcm9wVHlwZXMiLCJSZWFjdCIsIlRoZUJ1dHRvbiIsImlzUHJvZHVjdGlvbiIsImNoYW5nZWRQcm9wcyIsImV2ZW50SGFuZGxlcnNGb3IiLCJodG1sQXR0cmlidXRlc0ZvciIsIm5ld0lkIiwiVGhlSWNvbiIsIlRoZVNwaW4iLCJnZXQiLCJzZXR1cFZpZGVvRWxtIiwiVGhlVGFsa1N0eWxlIiwiY3NzQW1vdW50IiwidiIsIlRoZVRhbGsiLCJwcmVzZW50IiwiRElTQUJMRURfSUNPTiIsImNsaWVudCIsImlkIiwib25BdWRpb1RvZ2dsZSIsIm9uVmlkZW9Ub2dnbGUiLCJyZW5kZXJDbGllbnQiLCJ2aWRlb0hlaWdodCIsImF1ZGlvRW5hYmxlZCIsInZpZGVvRW5hYmxlZCIsImNvbnRlbnQiLCJoZWlnaHQiLCJBVURJT19JQ09OIiwiVklERU9fSUNPTiIsInByb3BzIiwiaGFuZGxlQXVkaW9Ub2dnbGUiLCJiaW5kIiwiaGFuZGxlVmlkZW9Ub2dnbGUiLCJlbG1SZWYiLCJjcmVhdGVSZWYiLCJfaWQiLCJwcmV2UHJvcHMiLCJkaWZmIiwicmVjZWl2ZUxvY2FsQ2xpZW50IiwibG9jYWxDbGllbnQiLCJyZWNlaXZlUmVtb3RlQ2xpZW50cyIsInJlbW90ZUNsaWVudHMiLCJvblRvZ2dsZUF1ZGlvIiwib25Ub2dnbGVWaWRlbyIsInJpZCIsImNoaWxkcmVuIiwiY2xhc3NOYW1lIiwibG9jYWxWaWRlb0hlaWdodCIsInJlbW90ZVZpZGVvSGVpZ2h0IiwicmVuZGVyTG9jYWxDbGllbnQiLCJyZW5kZXJSZW1vdGVDbGllbnQiLCJzcGlubmluZyIsImV4Y2VwdCIsIk9iamVjdCIsImVudHJpZXMiLCJtYXAiLCJyZW1vdGVDbGllbnRFbG1JZEZvciIsImxvY2FsQ2xpZW50RWxtSWQiLCJkb2N1bWVudCIsImNsaWVudEVsbSIsImdldEVsZW1lbnRCeUlkIiwiY29uc29sZSIsIndhcm4iLCJ2aWRlb0VsbSIsInF1ZXJ5U2VsZWN0b3IiLCJsb2NhbCIsInN0cmVhbSIsIkNvbXBvbmVudCIsIlN0eWxlIiwicHJvcFR5cGVzIiwib2JqZWN0Iiwib25WaWRlbyIsImZ1bmMiLCJvYmplY3RPZiIsIm9uZU9mVHlwZSIsInN0cmluZyIsIm51bWJlciIsImRlZmF1bHRQcm9wcyIsImRpc3BsYXlOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7O0FBRUEsU0FBU0EsT0FBVCxRQUF3QixPQUF4QjtBQUNBLE9BQU9DLENBQVAsTUFBYyxZQUFkO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixZQUF0QjtBQUNBLE9BQU9DLEtBQVAsTUFBa0IsT0FBbEI7QUFDQSxTQUFTQyxTQUFULFFBQTBCLFlBQTFCO0FBQ0EsU0FBU0MsWUFBVCxRQUE2QixXQUE3QjtBQUNBLFNBQVNDLFlBQVQsRUFBdUJDLGdCQUF2QixFQUF5Q0MsaUJBQXpDLEVBQTREQyxLQUE1RCxRQUF5RSxvQkFBekU7QUFDQSxTQUFTQyxPQUFULFFBQXdCLFVBQXhCO0FBQ0EsU0FBU0MsT0FBVCxRQUF3QixVQUF4QjtBQUNBLFNBQVNDLEdBQVQsUUFBb0IsWUFBcEI7QUFDQSxPQUFPQyxhQUFQLE1BQTBCLHlCQUExQjtBQUNBLE9BQU9DLFlBQVAsTUFBeUIsZ0JBQXpCOztBQUVBLElBQU1DLFNBQVMsR0FBRyxTQUFaQSxTQUFZLENBQUNDLENBQUQ7QUFBQSxTQUFPLE9BQU9BLENBQVAsS0FBYSxRQUFiLEdBQXdCQSxDQUFDLEdBQUcsSUFBNUIsR0FBbUNBLENBQTFDO0FBQUEsQ0FBbEI7QUFFQTs7Ozs7SUFHTUMsTzs7Ozs7Ozt1Q0FDOEI7QUFBQSxVQUFYQyxPQUFXLFFBQVhBLE9BQVc7O0FBQ2hDLFVBQUksQ0FBQ0EsT0FBTCxFQUFjO0FBQ1osZUFBTyxJQUFQO0FBQ0Q7O0FBQ0QsYUFDRSxvQkFBQyxPQUFEO0FBQVMsUUFBQSxTQUFTLEVBQUVqQixDQUFDLENBQUMsd0JBQUQsRUFBMkJnQixPQUFPLENBQUNFLGFBQW5DO0FBQXJCLFFBREY7QUFHRDs7O3VD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UyxDQUFDdUUsTUFBN0IsQ0FKRztBQUtsQnJCLEVBQUFBLGlCQUFpQixFQUFFbEQsU0FBUyxDQUFDeUUsSUFMWDtBQU1sQnRCLEVBQUFBLGtCQUFrQixFQUFFbkQsU0FBUyxDQUFDeUUsSUFOWjs7QUFPbEI7QUFDQWxELEVBQUFBLFdBQVcsRUFBRXZCLFNBQVMsQ0FBQzJFLFNBQVYsQ0FBb0IsQ0FDL0IzRSxTQUFTLENBQUM0RSxNQURxQixFQUUvQjVFLFNBQVMsQ0FBQzZFLE1BRnFCLENBQXBCO0FBUkssQ0FBcEI7QUFjQTlELE9BQU8sQ0FBQytELFlBQVIsR0FBdUI7QUFDckJ0QyxFQUFBQSxXQUFXLEVBQUUsSUFEUTtBQUVyQlEsRUFBQUEsZ0JBQWdCLEVBQUUsR0FGRztBQUdyQk4sRUFBQUEsYUFBYSxFQUFFLEVBSE07QUFJckJPLEVBQUFBLGlCQUFpQixFQUFFLEdBSkU7QUFLckJDLEVBQUFBLGlCQUFpQixFQUFFO0FBQUEsV0FBTSxJQUFOO0FBQUEsR0FMRTtBQU1yQkMsRUFBQUEsa0JBQWtCLEVBQUU7QUFBQSxXQUFNLElBQU47QUFBQTtBQU5DLENBQXZCO0FBU0FwQyxPQUFPLENBQUNnRSxXQUFSLEdBQXNCLFNBQXRCO0FBRUEsZUFBZWhFLE9BQWYiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmltcG9ydCB7IGNsZWFudXAgfSBmcm9tICdhc29iaidcbmltcG9ydCBjIGZyb20gJ2NsYXNzbmFtZXMnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBUaGVCdXR0b24gfSBmcm9tICd0aGUtYnV0dG9uJ1xuaW1wb3J0IHsgaXNQcm9kdWN0aW9uIH0gZnJvbSAndGhlLWNoZWNrJ1xuaW1wb3J0IHsgY2hhbmdlZFByb3BzLCBldmVudEhhbmRsZXJzRm9yLCBodG1sQXR0cmlidXRlc0ZvciwgbmV3SWQgfSBmcm9tICd0aGUtY29tcG9uZW50LXV0aWwnXG5pbXBvcnQgeyBUaGVJY29uIH0gZnJvbSAndGhlLWljb24nXG5pbXBvcnQgeyBUaGVTcGluIH0gZnJvbSAndGhlLXNwaW4nXG5pbXBvcnQgeyBnZXQgfSBmcm9tICd0aGUtd2luZG93J1xuaW1wb3J0IHNldHVwVmlkZW9FbG0gZnJvbSAnLi9oZWxwZXJzL3NldHVwVmlkZW9FbG0nXG5pbXBvcnQgVGhlVGFsa1N0eWxlIGZyb20gJy4vVGhlVGFsa1N0eWxlJ1xuXG5jb25zdCBjc3NBbW91bnQgPSAodikgPT4gdHlwZW9mIHYgPT09ICdudW1iZXInID8gdiArICdweCcgOiB2XG5cbi8qKlxuICogVGFsa2luZyB2aWEgd2VicnRjXG4gKi9cbmNsYXNzIFRoZVRhbGsgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICBzdGF0aWMgRGlzYWJsZWRJY29uICh7IHByZXNlbnQgfSkge1xuICAgIGlmICghcHJlc2VudCkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxUaGVJY29uIGNsYXNzTmFtZT17YygndGhlLXRhbGstZGlzYWJsZWQtaWNvbicsIFRoZVRhbGsuRElTQUJMRURfSUNPTil9Lz5cbiAgICApXG4gIH1cblxuICBzdGF0aWMgTG9jYWxDbGllbnQgKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgb25BdWRpb1RvZ2dsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uVmlkZW9Ub2dnbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJDbGllbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB2aWRlb0hlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICB9KSB7XG4gICAgaWYgKCFjbGllbnQpIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuICAgIGNvbnN0IHtcbiAgICAgIGF1ZGlvRW5hYmxlZCxcbiAgICAgIHZpZGVvRW5hYmxlZCxcbiAgICB9ID0gY2xpZW50XG4gICAgY29uc3QgY29udGVudCA9IHJlbmRlckNsaWVudChjbGllbnQpXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPSd0aGUtdGFsay1sb2NhbCdcbiAgICAgICAgICAgaWQ9e2lkfVxuICAgICAgPlxuICAgICAgICA8dmlkZW8gYXV0b1BsYXlcbiAgICAgICAgICAgICAgIGNsYXNzTmFtZT0ndGhlLXRhbGstdmlkZW8nXG4gICAgICAgICAgICAgICBtdXRlZFxuICAgICAgICAgICAgICAgcGxheXNJbmxpbmVcbiAgICAgICAgICAgICAgIHN0eWxlPXt7IGhlaWdodDogdmlkZW9IZWlnaHQgfX1cbiAgICAgICAgLz5cbiAgICAgICAge2NvbnRlbnQgJiYgPGRpdiBjbGFzc05hbWU9J3RoZS10YWxrLWNvbnRlbnQnPntjb250ZW50fTwvZGl2Pn1cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9e2MoJ3RoZS10YWxrLWFjdGlvbnMnLCB7fSl9PlxuICAgICAgICAgIDxUaGVCdXR0b24gY2xhc3NOYW1lPXtjKCd0aGUtdGFsay10b2dnbGUnLCB7XG4gICAgICAgICAgICAndGhlLXRhbGstdG9nZ2xlLWRpc2FibGVkJzogIWF1ZGlvRW5hYmxlZCxcbiAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAgICAgICAgIGljb249e1RoZVRhbGsuQVVESU9fSUNPTn1cbiAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e29uQXVkaW9Ub2dnbGV9XG4gICAgICAgICAgPlxuICAgICAgICAgICAgPFRoZVRhbGsuRGlzYWJsZWRJY29uIHByZXNlbnQ9eyFhdWRpb0VuYWJsZWR9Lz5cbiAgICAgICAgICA8L1RoZUJ1dHRvbj5cbiAgICAgICAgICA8VGhlQnV0dG9uIGNsYXNzTmFtZT17YygndGhlLXRhbGstdG9nZ2xlJywge1xuICAgICAgICAgICAgJ3RoZS10YWxrLXRvZ2dsZS1kaXNhYmxlZCc6ICF2aWRlb0VuYWJsZWQsXG4gICAgICAgICAgfSl9XG4gICAgICAgICAgICAgICAgICAgICBpY29uPXtUaGVUYWxrLlZJREVPX0lDT059XG4gICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtvblZpZGVvVG9nZ2xlfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxUaGVUYWxrLkRpc2FibGVkSWNvbiBwcmVzZW50PXshdmlkZW9FbmFibGVkfS8+XG4gICAgICAgICAgPC9UaGVCdXR0b24+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgc3RhdGljIFJlbW90ZUNsaWVudCAoeyBjbGllbnQsIGlkLCByZW5kZXJDbGllbnQsIHZpZGVvSGVpZ2h0IH0pIHtcbiAgICBpZiAoIWNsaWVudCkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gICAgY29uc3QgY29udGVudCA9IHJlbmRlckNsaWVudChjbGllbnQpXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPSd0aGUtdGFsay1yZW1vdGUnXG4gICAgICAgICAgIGlkPXtpZH1cbiAgICAgID5cbiAgICAgICAgPHZpZGVvIGF1dG9QbGF5XG4gICAgICAgICAgICAgICBjbGFzc05hbWU9J3RoZS10YWxrLXZpZGVvJ1xuICAgICAgICAgICAgICAgcGxheXNJbmxpbmVcbiAgICAgICAgICAgICAgIHN0eWxlPXt7IGhlaWdodDogdmlkZW9IZWlnaHQgfX1cbiAgICAgICAgLz5cbiAgICAgICAge2NvbnRlbnQgJiYgPGRpdiBjbGFzc05hbWU9J3RoZS10YWxrLWNvbnRlbnQnPntjb250ZW50fTwvZGl2Pn1cbiAgICAgIDwvZGl2PlxuICAgIClcbiAgfVxuXG4gIGNvbnN0cnVjdG9yIChwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKVxuICAgIHRoaXMuaGFuZGxlQXVkaW9Ub2dnbGUgPSB0aGlzLmhhbmRsZUF1ZGlvVG9nZ2xlLmJpbmQodGhpcylcbiAgICB0aGlzLmhhbmRsZVZpZGVvVG9nZ2xlID0gdGhpcy5oYW5kbGVWaWRlb1RvZ2dsZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5lbG1SZWYgPSBSZWFjdC5jcmVhdGVSZWYoKVxuICAgIHRoaXMuX2lkID0gbmV3SWQoKVxuICB9XG5cbiAgZ2V0IGlkICgpIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5pZCB8fCB0aGlzLl9pZFxuICB9XG5cbiAgZ2V0IGxvY2FsQ2xpZW50RWxtSWQgKCkge1xuICAgIHJldHVybiBgJHt0aGlzLmlkfS1sb2NhbGBcbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50ICgpIHtcbiAgfVxuXG4gIGNvbXBvbmVudERpZFVwZGF0ZSAocHJldlByb3BzKSB7XG4gICAgY29uc3QgZGlmZiA9IGNoYW5nZWRQcm9wcyhwcmV2UHJvcHMsIHRoaXMucHJvcHMpXG4gICAgaWYgKCdsb2NhbENsaWVudCcgaW4gZGlmZikge1xuICAgICAgdm9pZCB0aGlzLnJlY2VpdmVMb2NhbENsaWVudChkaWZmLmxvY2FsQ2xpZW50KVxuICAgIH1cbiAgICBpZiAoJ3JlbW90ZUNsaWVudHMnIGluIGRpZmYpIHtcbiAgICAgIHZvaWQgdGhpcy5yZWNlaXZlUmVtb3RlQ2xpZW50cyhkaWZmLnJlbW90ZUNsaWVudHMpXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQgKCkge1xuICB9XG5cbiAgaGFuZGxlQXVkaW9Ub2dnbGUgKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHByb3BzOiB7IGxvY2FsQ2xpZW50LCBvblRvZ2dsZUF1ZGlvIH0sXG4gICAgfSA9IHRoaXNcbiAgICBjb25zdCB7IGF1ZGlvRW5hYmxlZCB9ID0gbG9jYWxDbGllbnQgfHwge31cbiAgICBvblRvZ2dsZUF1ZGlvICYmIG9uVG9nZ2xlQXVkaW8oIWF1ZGlvRW5hYmxlZClcbiAgfVxuXG4gIGhhbmRsZVZpZGVvVG9nZ2xlICgpIHtcbiAgICBjb25zdCB7XG4gICAgICBwcm9wczogeyBsb2NhbENsaWVudCwgb25Ub2dnbGVWaWRlbyB9LFxuICAgIH0gPSB0aGlzXG4gICAgY29uc3QgeyB2aWRlb0VuYWJsZWQgfSA9IGxvY2FsQ2xpZW50IHx8IHt9XG4gICAgb25Ub2dnbGVWaWRlbyAmJiBvblRvZ2dsZVZpZGVvKCF2aWRlb0VuYWJsZWQpXG4gIH1cblxuICByZW1vdGVDbGllbnRFbG1JZEZvciAocmlkKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuaWR9LXJlbW90ZS0ke3JpZH1gXG4gIH1cblxuICByZW5kZXIgKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXNcbiAgICBjb25zdCB7XG4gICAgICBjaGlsZHJlbixcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgIGxvY2FsQ2xpZW50LFxuICAgICAgbG9jYWxWaWRlb0hlaWdodCxcbiAgICAgIHJlbW90ZUNsaWVudHMsXG4gICAgICByZW1vdGVWaWRlb0hlaWdodCxcbiAgICAgIHJlbmRlckxvY2FsQ2xpZW50LFxuICAgICAgcmVuZGVyUmVtb3RlQ2xpZW50LFxuICAgICAgc3Bpbm5pbmcsXG4gICAgfSA9IHByb3BzXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgey4uLmh0bWxBdHRyaWJ1dGVzRm9yKHByb3BzLCB7IGV4Y2VwdDogWydjbGFzc05hbWUnXSB9KX1cbiAgICAgICAgICAgey4uLmV2ZW50SGFuZGxlcnNGb3IocHJvcHMsIHsgZXhjZXB0OiBbXSB9KX1cbiAgICAgICAgICAgY2xhc3NOYW1lPXtjKCd0aGUtdGFsaycsIGNsYXNzTmFtZSwge1xuICAgICAgICAgICAgICd0aGUtdGFsay1yZWFkeSc6ICEhbG9jYWxDbGllbnQsXG4gICAgICAgICAgIH0pfVxuICAgICAgICAgICBpZD17dGhpcy5pZH1cbiAgICAgICAgICAgcmVmPXt0aGlzLmVsbVJlZn1cbiAgICAgID5cblxuICAgICAgICB7XG4gICAgICAgICAgc3Bpbm5pbmcgJiYgPFRoZVNwaW4gY292ZXIgZW5hYmxlZC8+XG4gICAgICAgIH1cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J3RoZS10YWxrLXZpZGVvLXJlbW90ZS1jb250YWluZXInXG4gICAgICAgID5cbiAgICAgICAgICB7XG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZW1vdGVDbGllbnRzKS5tYXAoKFtyaWQsIGNsaWVudF0pID0+IChcbiAgICAgICAgICAgICAgPFRoZVRhbGsuUmVtb3RlQ2xpZW50IGNsaWVudD17Y2xpZW50fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ9e3RoaXMucmVtb3RlQ2xpZW50RWxtSWRGb3IocmlkKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17cmlkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQ2xpZW50PXtyZW5kZXJSZW1vdGVDbGllbnR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWRlb0hlaWdodD17Y3NzQW1vdW50KHJlbW90ZVZpZGVvSGVpZ2h0KX0vPlxuICAgICAgICAgICAgKSlcbiAgICAgICAgICB9XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPSd0aGUtdGFsay12aWRlby1sb2NhbC1jb250YWluZXInXG4gICAgICAgID5cbiAgICAgICAgICA8VGhlVGFsay5Mb2NhbENsaWVudCBjbGllbnQ9e2xvY2FsQ2xpZW50fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkPXt0aGlzLmxvY2FsQ2xpZW50RWxtSWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25BdWRpb1RvZ2dsZT17dGhpcy5oYW5kbGVBdWRpb1RvZ2dsZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblZpZGVvVG9nZ2xlPXt0aGlzLmhhbmRsZVZpZGVvVG9nZ2xlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckNsaWVudD17cmVuZGVyTG9jYWxDbGllbnR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9IZWlnaHQ9e2Nzc0Ftb3VudChsb2NhbFZpZGVvSGVpZ2h0KX1cbiAgICAgICAgICAvPlxuICAgICAgICA8L2Rpdj5cblxuICAgICAgICB7Y2hpbGRyZW59XG4gICAgICA8L2Rpdj5cbiAgICApXG4gIH1cblxuICBhc3luYyByZWNlaXZlTG9jYWxDbGllbnQgKGxvY2FsQ2xpZW50KSB7XG4gICAgY29uc3QgZG9jdW1lbnQgPSBnZXQoJ2RvY3VtZW50JylcbiAgICBjb25zdCBjbGllbnRFbG0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmxvY2FsQ2xpZW50RWxtSWQpXG4gICAgaWYgKCFjbGllbnRFbG0pIHtcbiAgICAgIGNvbnNvbGUud2FybignW1RoZVRhbGtdIGxvY2FsIGNsaWVudEVsbSBub3QgcmVhZHknKVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IHZpZGVvRWxtID0gY2xpZW50RWxtLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJylcbiAgICBhd2FpdCBzZXR1cFZpZGVvRWxtKHZpZGVvRWxtLCB7XG4gICAgICBsb2NhbDogdHJ1ZSxcbiAgICAgIHN0cmVhbTogbG9jYWxDbGllbnQuc3RyZWFtLFxuICAgIH0pXG4gIH1cblxuICBhc3luYyByZWNlaXZlUmVtb3RlQ2xpZW50cyAocmVtb3RlQ2xpZW50cykge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gZ2V0KCdkb2N1bWVudCcpXG4gICAgZm9yIChjb25zdCBbcmlkLCBjbGllbnRdIG9mIE9iamVjdC5lbnRyaWVzKHJlbW90ZUNsaWVudHMpKSB7XG4gICAgICBjb25zdCBjbGllbnRFbG0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLnJlbW90ZUNsaWVudEVsbUlkRm9yKHJpZCkpXG4gICAgICBpZiAoIWNsaWVudEVsbSkge1xuICAgICAgICBjb25zb2xlLndhcm4oJ1tUaGVUYWxrXSByZW1vdGUgY2xpZW50RWxtIG5vdCByZWFkeScpXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgY29uc3QgdmlkZW9FbG0gPSBjbGllbnRFbG0ucXVlcnlTZWxlY3RvcigndmlkZW8nKVxuICAgICAgYXdhaXQgc2V0dXBWaWRlb0VsbSh2aWRlb0VsbSwge1xuICAgICAgICBsb2NhbDogZmFsc2UsXG4gICAgICAgIHN0cmVhbTogY2xpZW50LnN0cmVhbSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG59XG5cblRoZVRhbGsuQVVESU9fSUNPTiA9ICdmYXMgZmEtbWljcm9waG9uZSdcblRoZVRhbGsuVklERU9fSUNPTiA9ICdmYXMgZmEtdmlkZW8nXG5UaGVUYWxrLkRJU0FCTEVEX0lDT04gPSAnZmFzIGZhLWJhbidcblxuVGhlVGFsay5TdHlsZSA9IFRoZVRhbGtTdHlsZVxuXG5UaGVUYWxrLnByb3BUeXBlcyA9IHtcbiAgLyoqIEhhbmRsZSB2aWRlbyAqL1xuICBsb2NhbENsaWVudDogUHJvcFR5cGVzLm9iamVjdCxcbiAgb25WaWRlbzogUHJvcFR5cGVzLmZ1bmMsXG4gIHJlbW90ZUNsaWVudHM6IFByb3BUeXBlcy5vYmplY3RPZihQcm9wVHlwZXMub2JqZWN0KSxcbiAgcmVuZGVyTG9jYWxDbGllbnQ6IFByb3BUeXBlcy5mdW5jLFxuICByZW5kZXJSZW1vdGVDbGllbnQ6IFByb3BUeXBlcy5mdW5jLFxuICAvKiogSGVpZ2h0IG9mIHZpZGVvICovXG4gIHZpZGVvSGVpZ2h0OiBQcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIFByb3BUeXBlcy5udW1iZXIsXG4gIF0pLFxufVxuXG5UaGVUYWxrLmRlZmF1bHRQcm9wcyA9IHtcbiAgbG9jYWxDbGllbnQ6IG51bGwsXG4gIGxvY2FsVmlkZW9IZWlnaHQ6IDEwMCxcbiAgcmVtb3RlQ2xpZW50czoge30sXG4gIHJlbW90ZVZpZGVvSGVpZ2h0OiAyMDAsXG4gIHJlbmRlckxvY2FsQ2xpZW50OiAoKSA9PiBudWxsLFxuICByZW5kZXJSZW1vdGVDbGllbnQ6ICgpID0+IG51bGwsXG59XG5cblRoZVRhbGsuZGlzcGxheU5hbWUgPSAnVGhlVGFsaydcblxuZXhwb3J0IGRlZmF1bHQgVGhlVGFsa1xuIl19